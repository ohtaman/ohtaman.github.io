<!doctype html><html dir=ltr lang=en data-theme class="html theme--light"><head><meta charset=utf-8><title>ohtaman
|
はじめてのHPCによる深層学習 〜スーパーコンピューターに触れてみる〜
</title><meta name=generator content="Hugo 0.146.5"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=author content="ohtaman"><meta name=description content="Machine Learning Engineer"><link rel=stylesheet href=/scss/main.min.8d4fad7e6916ad2e291e8d97ada157c70350d6d7150fea137e7243340967befb.css integrity="sha256-jU+tfmkWrS4pHo2XraFXxwNQ1tcVD+oTfnJDNAlnvvs=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/css/markupHighlight.min.73ccfdf28df555e11009c13c20ced067af3cb021504cba43644c705930428b00.css integrity="sha256-c8z98o31VeEQCcE8IM7QZ688sCFQTLpDZExwWTBCiwA=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/css/custom_style.min.6153cbfcc88c313de058d6b0a30d52dc84e37a329c1ac6ef5dabae4cdf29e328.css integrity="sha256-YVPL/MiMMT3gWNawow1S3ITjejKcGsbvXauuTN8p4yg=" crossorigin=anonymous media=screen><link rel=stylesheet href=/fontawesome/css/fontawesome.min.137b1cf3cea9a8adb7884343a9a5ddddf4280f59153f74dc782fb7f7bf0d0519.css integrity="sha256-E3sc886pqK23iENDqaXd3fQoD1kVP3TceC+3978NBRk=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/solid.min.e65dc5b48fb5f39b142360c57c3a215744c94e56c755c929cc3e88fe12aab4d3.css integrity="sha256-5l3FtI+185sUI2DFfDohV0TJTlbHVckpzD6I/hKqtNM=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/regular.min.6f4f16d58da1c82c0c3a3436e021a3d39b4742f741192c546e73e947eacfd92f.css integrity="sha256-b08W1Y2hyCwMOjQ24CGj05tHQvdBGSxUbnPpR+rP2S8=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/brands.min.e10425ad768bc98ff1fb272a0ac8420f9d1ba22f0612c08ff1010c95080ffe7e.css integrity="sha256-4QQlrXaLyY/x+ycqCshCD50boi8GEsCP8QEMlQgP/n4=" crossorigin=anonymous type=text/css><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=canonical href=https://ohtaman.github.io/slides/ml_15min/20211127/><script type=text/javascript src=/js/anatole-header.min.f9132794301a01ff16550ed66763482bd848f62243d278f5e550229a158bfd32.js integrity="sha256-+RMnlDAaAf8WVQ7WZ2NIK9hI9iJD0nj15VAimhWL/TI=" crossorigin=anonymous></script><script type=text/javascript src=/js/anatole-theme-switcher.min.d6d329d93844b162e8bed1e915619625ca91687952177552b9b3e211014a2957.js integrity="sha256-1tMp2ThEsWLovtHpFWGWJcqRaHlSF3VSubPiEQFKKVc=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.js></script><script src=https://code.jquery.com/jquery-3.2.1.min.js></script><script type=text/javascript src=/js/script.min.cc7a663bc8575d48514cf7dbb55c0c81bd16263686e0ee3066582f2680d4f348.js integrity="sha256-zHpmO8hXXUhRTPfbtVwMgb0WJjaG4O4wZlgvJoDU80g=" crossorigin=anonymous></script><meta name=twitter:card content="summary"><meta name=twitter:title content="はじめてのHPCによる深層学習 〜スーパーコンピューターに触れてみる〜"><meta name=twitter:description content="はじめてのHPCによる深層学習
〜スーパーコンピューターに触れてみる〜 ohtaman 第61回 Machine Learning 15minutes! V-expo (2021/11/27)
自己紹介 太田 満久 (ohtaman) CDTO (Chief Data Technology Officer) at BrainPad Inc. Google Developers Expert (Machine Learning). An organizer of TensorFlow User Group Tokyo. https://www.cc.u-tokyo.ac.jp/events/lectures/159/"><meta property="og:url" content="https://ohtaman.github.io/slides/ml_15min/20211127/"><meta property="og:site_name" content="ohtaman"><meta property="og:title" content="はじめてのHPCによる深層学習 〜スーパーコンピューターに触れてみる〜"><meta property="og:description" content="はじめてのHPCによる深層学習
〜スーパーコンピューターに触れてみる〜 ohtaman 第61回 Machine Learning 15minutes! V-expo (2021/11/27)
自己紹介 太田 満久 (ohtaman) CDTO (Chief Data Technology Officer) at BrainPad Inc. Google Developers Expert (Machine Learning). An organizer of TensorFlow User Group Tokyo. https://www.cc.u-tokyo.ac.jp/events/lectures/159/"><meta property="og:locale" content="ja_JP"><meta property="og:type" content="article"><meta property="article:section" content="slides"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","articleSection":"slides","name":"はじめてのHPCによる深層学習 〜スーパーコンピューターに触れてみる〜","headline":"はじめてのHPCによる深層学習 〜スーパーコンピューターに触れてみる〜","alternativeHeadline":"","description":"
      
        \u003cstyle\u003e\n\nsection {\n    background-color: white;\n}\n\nsection.with_img {\n    padding-right: 420px;\n}\n\nsection.with_img img {\n    position: absolute;\n    left: 900px;\n}\n\nstrong {\n    color: red;\n}\n\nh1 {\n    position: absolute;\n    left: 72px; top: 100px;\n}\n\nsection.title h1 {\n    position: relative;\n    top: 0px;\n    left: 0px;\n}\n\n\u003c\/style\u003e\n\u003c!-- _class: title --\u003e\n\u003ch1 id=\u0022はじめてのhpcによる深層学習スーパーコンピューターに触れてみる\u0022\u003eはじめてのHPCによる深層学習\u003cbr\u003e〜スーパーコンピューターに触れてみる〜\u003c\/h1\u003e\n\u003cp\u003e\u003cb\u003eohtaman\u003c\/b\u003e\n第61回 Machine Learning 15minutes! V-expo (2021\/11\/27)\u003c\/p\u003e\n\u003chr\u003e\n\u003c!-- pagination: true --\u003e\n\u003c!-- _class: with_img --\u003e\n\u003ch1 id=\u0022自己紹介\u0022\u003e自己紹介\u003c\/h1\u003e\n\u003ch3 id=\u0022太田-満久-ohtaman\u0022\u003e太田 満久 (ohtaman)\u003c\/h3\u003e\n\u003cul\u003e\n\u003cli\u003eCDTO (Chief Data Technology Officer) at BrainPad Inc.\u003c\/li\u003e\n\u003cli\u003eGoogle Developers Expert (Machine Learning).\u003c\/li\u003e\n\u003cli\u003eAn organizer of TensorFlow User Group Tokyo.\u003c\/li\u003e\n\u003c\/ul\u003e\n\u003cimg src=\u0022https:\/\/avatars2.githubusercontent.com\/u\/329750\u0022 style=\u0022height: 240px;  border-radius: 50%;\u0022\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cimg src=\u0022imgs\/gpu_minicamp.png\u0022 alt=\u0022\u0022\u003e\n\u003ca href=\u0022https:\/\/www.cc.u-tokyo.ac.jp\/events\/lectures\/159\/\u0022\u003ehttps:\/\/www.cc.u-tokyo.ac.jp\/events\/lectures\/159\/\u003c\/a\u003e\u003c\/p\u003e


      


    ","inLanguage":"ja-JP","isFamilyFriendly":"true","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/ohtaman.github.io\/slides\/ml_15min\/20211127\/"},"author":{"@type":"Person","name":"ohtaman"},"creator":{"@type":"Person","name":"ohtaman"},"accountablePerson":{"@type":"Person","name":"ohtaman"},"copyrightHolder":{"@type":"Person","name":"ohtaman"},"copyrightYear":"0001","dateCreated":"0001-01-01T00:00:00.00Z","datePublished":"0001-01-01T00:00:00.00Z","dateModified":"0001-01-01T00:00:00.00Z","publisher":{"@type":"Organization","name":"ohtaman","url":"https://ohtaman.github.io/","logo":{"@type":"ImageObject","url":"https:\/\/ohtaman.github.io\/favicon-32x32.png","width":"32","height":"32"}},"image":[],"url":"https:\/\/ohtaman.github.io\/slides\/ml_15min\/20211127\/","wordCount":"373","genre":[],"keywords":[]}</script></head><body class=body><div class=wrapper><aside class=wrapper__sidebar><div class="sidebar
."><div class=sidebar__content><div class=sidebar__introduction><img class=sidebar__introduction-profileimage src=/imgs/profile.jpg alt="profile picture"><div class=sidebar__introduction-title><a href=/>ohtaman</a></div><div class=sidebar__introduction-description><p>Machine Learning Engineer</p></div></div><ul class=sidebar__list><li class=sidebar__list-item><a href=https://g.dev/ohtaman target=_blank rel="noopener me" aria-label="Google Developers Profile" title="Google Developers Profile"><i class="fab fa-google fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=https://github.com/ohtaman target=_blank rel="noopener me" aria-label=GitHub title=GitHub><i class="fab fa-github fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=https://twitter.com/ohtaman target=_blank rel="noopener me" aria-label=Twitter title=Twitter><i class="fab fa-twitter fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=https://facebook.com/ohtaman target=_blank rel="noopener me" aria-label=Facebook title=Facebook><i class="fab fa-facebook fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=https://www.linkedin.com/in/ohtaman/ target=_blank rel="noopener me" aria-label=Linkedin title=Linkedin><i class="fab fa-linkedin fa-2x" aria-hidden=true></i></a></li></ul></div><footer class="footer footer__sidebar"><ul class=footer__list><li class=footer__item>&copy;
ohtaman
2025</li></ul></footer><script type=text/javascript src=/js/medium-zoom.min.1248fa75275e5ef0cbef27e8c1e27dc507c445ae3a2c7d2ed0be0809555dac64.js integrity="sha256-Ekj6dSdeXvDL7yfoweJ9xQfERa46LH0u0L4ICVVdrGQ=" crossorigin=anonymous></script></div></aside><main class=wrapper__main><header class=header><div class=.><a role=button class=navbar-burger data-target=navMenu aria-label=menu aria-expanded=false><span aria-hidden=true class=navbar-burger__line></span>
<span aria-hidden=true class=navbar-burger__line></span>
<span aria-hidden=true class=navbar-burger__line></span></a><nav class=nav><ul class=nav__list id=navMenu><li class=nav__list-item><a href=/ title>Home</a></li><li class=nav__list-item><a href=/events title>Events</a></li><li class=nav__list-item><a href=/talks/ title>Talks</a></li><li class=nav__list-item><a href=/articles title>Articles</a></li><li class=nav__list-item><a href=/publications title>Publications</a></li><li class=nav__list-item><a href=https://0-8.hatenadiary.jp/ target=_blank rel="noopener noreferrer" title>Blog</a></li></ul><ul class="nav__list nav__list--end"><li class=nav__list-item><div class=themeswitch><a title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></li></ul></nav></div></header><div class="post
."><div class=post__content><h1>はじめてのHPCによる深層学習 〜スーパーコンピューターに触れてみる〜</h1><style>section{background-color:#fff}section.with_img{padding-right:420px}section.with_img img{position:absolute;left:900px}strong{color:red}h1{position:absolute;left:72px;top:100px}section.title h1{position:relative;top:0;left:0}</style><h1 id=はじめてのhpcによる深層学習スーパーコンピューターに触れてみる>はじめてのHPCによる深層学習<br>〜スーパーコンピューターに触れてみる〜</h1><p><b>ohtaman</b>
第61回 Machine Learning 15minutes! V-expo (2021/11/27)</p><hr><h1 id=自己紹介>自己紹介</h1><h3 id=太田-満久-ohtaman>太田 満久 (ohtaman)</h3><ul><li>CDTO (Chief Data Technology Officer) at BrainPad Inc.</li><li>Google Developers Expert (Machine Learning).</li><li>An organizer of TensorFlow User Group Tokyo.</li></ul><img src=https://avatars2.githubusercontent.com/u/329750 style=height:240px;border-radius:50%><hr><p><img src=imgs/gpu_minicamp.png alt>
<a href=https://www.cc.u-tokyo.ac.jp/events/lectures/159/>https://www.cc.u-tokyo.ac.jp/events/lectures/159/</a></p><hr><p><img src=imgs/abci_minicamp.png alt>
<a href=https://abciug.abci.ai/minicamp202105-p53>https://abciug.abci.ai/minicamp202105-p53</a></p><hr><h1 id=gpuミニキャンプを通じて知ったこと>GPUミニキャンプを通じて知ったこと</h1><ol><li>スパコンは特殊な装置ではない。使い方さえ知っていれば、案外簡単に使える。</li><li>スパコンは学術研究以外にも使える（利用規約や運用方針による）。</li><li>スパコンは思っていたよりも安い。</li></ol><hr><h1 id=スパコンを使うメリット>スパコンを使うメリット</h1><ol><li>大量のマシンによる並列分散処理で、モデルの訓練時間を短縮できる</li><li>クラウドサービスよりも安価に利用できる</li></ol><p><img src=imgs/many_gpus.png alt="bg right contain"></p><hr><h1 id=参考-abci-の料金体系>参考: ABCI の料金体系</h1><ul><li>ポイント制（1ポイント220円）</li><li>3.0ポイント/時間
(A100x8, 72コア, 480GBメモリ, 2021年度の料金設定)</li></ul><p><img src=imgs/abci_pricing.png alt="bg right contain"></p><hr><h1 id=スパコンを使うメリット-1>スパコンを使うメリット</h1><ol><li>大量のマシンによる並列分散処理で、モデルの訓練時間を短縮できる</li><li>クラウドサービスよりも安価に利用できる</li></ol><p><strong>でも、利用イメージがわかないので始められない&mldr;</strong></p><p><img src=imgs/many_gpus.png alt="bg right contain"></p><hr><h2 id=というわけで主に深層学習のモデル構築を想定したスパコンhpcの利用イメージを紹介します>というわけで、主に深層学習のモデル構築を想定したスパコン（HPC）の利用イメージを紹介します</h2><hr><h1 id=覚えておくと良さそうなこと>覚えておくと良さそうなこと</h1><ol><li>ジョブスケジューラー</li><li>Environment Modules</li></ol><hr><h1 id=覚えておくと良さそうなこと-1>覚えておくと良さそうなこと</h1><ol><li><strong>ジョブスケジューラ</strong>: 複数人からの依頼に応じてリソースの割り当てを行う</li><li>Environment Modules</li></ol><hr><h1 id=システムの全体像>システムの全体像</h1><p><img src=imgs/hpc.png alt="bg width:80%"></p><hr><h1 id=システムの全体像-1>システムの全体像</h1><ol><li>ログインノード
ユーザーがログインして各種設定やジョブの投入を行う</li><li>計算ノード
ジョブを受け取り、計算を行う</li><li>管理ノード
リソースやキューの管理を行う</li></ol><p><img src=imgs/hpc.png alt="bg right contain"></p><hr><h1 id=ジョブ実行の流れ>ジョブ実行の流れ</h1><ol><li>ログインノードにログイン</li><li>計算に必要なファイルの準備</li><li>(optional) インタラクティブジョブで動作確認</li><li>バッチジョブを実行</li><li>結果の確認</li></ol><p><img src=imgs/hpc.png alt="bg right contain"></p><hr><p><img src=https://docs.abci.ai/ja/img/abci_system_ja.svg alt=width:80%></p><p>ABCIシステムの概要: <a href=https://docs.abci.ai/ja/system-overview/>https://docs.abci.ai/ja/system-overview/</a></p><hr><h1 id=覚えておくと良さそうなこと-2>覚えておくと良さそうなこと</h1><ol><li>ジョブスケジューラ: 複数人からの依頼に応じてリソースの割り当てを行う</li><li><strong>Environment Modules</strong>: 利用するライブラリの管理を行う</li></ol><hr><h1 id=environment-modules-の利用例>Environment Modules の利用例</h1><p><code>module</code> コマンドを用いて、使いたいライブラリの使いたいバージョンをロード</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ module avail  <span style=color:#75715e># 利用可能なモジュールの確認</span>
</span></span><span style=display:flex><span>-------------------- /usr/share/Modules/modulefiles ---------------------
</span></span><span style=display:flex><span>dot  module-git  module-info  modules  null  use.own  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>------------------------ /usr/share/modulefiles -------------------------
</span></span><span style=display:flex><span>mpi/mpich-x86_64
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ module load mpi <span style=color:#75715e># モジュールのロード</span>
</span></span><span style=display:flex><span>$ module list <span style=color:#75715e># ロード済みモジュールの確認</span>
</span></span><span style=display:flex><span>Currently Loaded Modulefiles:
</span></span><span style=display:flex><span> 1<span style=color:#f92672>)</span> mpi/mpich-x86_64  
</span></span></code></pre></div><hr><h2 id=でも触ってみないと実感が湧かないよ>でも、触ってみないと実感が湧かないよ&mldr;</h2><hr><h2 id=ということで疑似環境を用意しました>ということで、疑似環境を用意しました</h2><p><a href=https://github.com/ohtaman/docker-compose-hpc>https://github.com/ohtaman/docker-compose-hpc</a></p><hr><h1 id=docker-compose-hpc>docker-compose-hpc</h1><ul><li>docker-compose による構成</li><li>ホストのディレクトリを共有</li><li>OpenPBS の利用</li><li>Environment Modules の利用</li></ul><center><p><img src=https://github.com/ohtaman/docker-compose-hpc/raw/main/img/docker-compose-hpc.png alt="bg right contain"></p></center><hr><h1 id=クラスタの構築>クラスタの構築</h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>host$ docker-compose up -d
</span></span></code></pre></div><hr><h1 id=ログイン>ログイン</h1><p>ログインノード（login）が SSH を待ち受けている</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>host$ docker-compose ps  
</span></span><span style=display:flex><span>            Name                        Command            State          Ports        
</span></span><span style=display:flex><span>---------------------------------------------------------------------------------------
</span></span><span style=display:flex><span>docker-compose-hpc_compute_1   /bin/sh -c /entrypoint.sh   Up                          
</span></span><span style=display:flex><span>docker-compose-hpc_head_1      /bin/sh -c /entrypoint.sh   Up                          
</span></span><span style=display:flex><span>docker-compose-hpc_login_1     /bin/sh -c /entrypoint.sh   Up      0.0.0.0:2022-&gt;22/tcp
</span></span></code></pre></div><p>ホストのユーザー名でログインノードにログイン</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>host$ ssh -i ssh/id_rsa -p <span style=color:#ae81ff>2022</span> localhost
</span></span></code></pre></div><hr><h1 id=ジョブの実行>ジョブの実行</h1><p>スクリプトの中身を確認</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat mnist.sh
</span></span><span style=display:flex><span><span style=color:#75715e>#!/bin/sh</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#PBS -q workq</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#PBS -l nodes=1:ppn=1</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#PBS -l mem=2G</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># qsubを実行したディレクトリに移動</span>
</span></span><span style=display:flex><span>cd <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>PBS_O_WORKDIR<span style=color:#66d9ef>:-$(</span>pwd<span style=color:#66d9ef>)</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>source .venv/bin/activate
</span></span><span style=display:flex><span>python mnist.py
</span></span></code></pre></div><hr><h1 id=ジョブの実行-1>ジョブの実行</h1><p><code>qsub</code> コマンドでジョブを送信</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ qsub job.sh
</span></span></code></pre></div><p><code>qstat</code> コマンドでジョブの状態を確認。実行中のジョブがない場合は何も表示されない。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ qstat
</span></span><span style=display:flex><span>Job id            Name             User              Time Use S Queue
</span></span><span style=display:flex><span>----------------  ---------------- ----------------  -------- - -----
</span></span><span style=display:flex><span>0.head            job.sh           ohtaman           00:00:00 R workq    
</span></span></code></pre></div><hr><h1 id=計算ノードの追加>計算ノードの追加</h1><p>docker-compose なので、計算ノードを（仮想的に）好きなだけ追加できる</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>host$ docker-compose up -d --scale compute<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> 
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>host$ docker-compose ps  
</span></span><span style=display:flex><span>            Name                        Command            State          Ports        
</span></span><span style=display:flex><span>---------------------------------------------------------------------------------------
</span></span><span style=display:flex><span>docker-compose-hpc_compute_1   /bin/sh -c /entrypoint.sh   Up                          
</span></span><span style=display:flex><span>docker-compose-hpc_head_1      /bin/sh -c /entrypoint.sh   Up                          
</span></span><span style=display:flex><span>docker-compose-hpc_head_2      /bin/sh -c /entrypoint.sh   Up                          
</span></span><span style=display:flex><span>docker-compose-hpc_login_1     /bin/sh -c /entrypoint.sh   Up      0.0.0.0:2022-&gt;22/tcp
</span></span></code></pre></div><hr><h1 id=mpi-による分散処理>MPI による分散処理</h1><p>MPI を用いると、複数の計算ノードで並列計算できる (以下の例では <code>nodes=2:ppn=2</code> で2ノードで2プロセスずつ実行するよう指定)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat mpi.sh
</span></span><span style=display:flex><span><span style=color:#75715e>#!/bin/sh</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#PBS -q workq</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#PBS -l nodes=2:ppn=2</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#PBS -l mem=2G</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>module load mpi
</span></span><span style=display:flex><span>mpirun hostname
</span></span></code></pre></div><hr><h1 id=mpi-による分散処理-1>MPI による分散処理</h1><p>ログを見ると、2つの計算ノード（572085e2d423, f565b6b4a09b）それぞれで2プロセスずつ実行されていることがわかる</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ qsub mpi.sh
</span></span><span style=display:flex><span>... <span style=color:#f92672>(</span>ジョブが終了するまで待機する<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>$ cat mpi.sh.o1 
</span></span><span style=display:flex><span>572085e2d423
</span></span><span style=display:flex><span>572085e2d423
</span></span><span style=display:flex><span>f565b6b4a09b
</span></span><span style=display:flex><span>f565b6b4a09b
</span></span></code></pre></div><hr><h1 id=optuna-による並列分散最適化>Optuna による並列分散最適化</h1><p>機械学習で複数ノードを利用する場合、1つのモデルを複数ノードで訓練することもできるが、パラメーター探索などで大量のモデルを構築したい場合は、各ノードにモデルを割り当て、それぞれ独立に訓練すると、実装がシンプルになる。</p><hr><h1 id=optuna-による並列分散最適化-1>Optuna による並列分散最適化</h1><p>Optuna を使って MPI を用いたパラメーター探索を行う場合は、以下のように適切な storage を指定するだけ</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>main</span>():
</span></span><span style=display:flex><span>    <span style=color:#75715e># Optuna で分散並列最適化を行うには、storage を指定する</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># https://www.slideshare.net/pfi/20201023-optunalectureatnagoyauni-238946529</span>
</span></span><span style=display:flex><span>    study <span style=color:#f92672>=</span> optuna<span style=color:#f92672>.</span>create_study(
</span></span><span style=display:flex><span>        direction<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;maximize&#39;</span>,
</span></span><span style=display:flex><span>        storage<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;sqlite:///db.sqlite3&#39;</span>,
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    study<span style=color:#f92672>.</span>optimize(objective, n_trials<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span></code></pre></div><p><small>※ SQLite ではなく PostgreSQL の方が安心</small></p><hr><h1 id=スパコン利用の注意点>スパコン利用の注意点</h1><ol><li>個人利用はできないことが多い（利用規約や運営方針による）</li><li>初期費用（最低のチャージ）が発生することがある</li><li>一般のクラウドサービスと異なり、サービング環境はないため訓練のみ利用可能</li><li>グランドチャレンジなど優先的なプロジェクトがあるため、常時実行するようなジョブには向いていない</li></ol><hr><h1 id=まとめ>まとめ</h1><ol><li>スパコンは民間利用もできて、安い。使い方も難しくない。</li><li>体験していただけるように docker-compose で疑似環境を作ってみたので触ってみてね</li></ol><hr><h1 id=参考資料>参考資料</h1><ul><li><a href=https://github.com/ohtaman/docker-compose-hpc>docker-compose-hpc</a><ul><li>スライドで紹介した疑似環境</li></ul></li><li><a href=https://kaityo256.github.io/sevendayshpc/>一週間でなれる！スパコンプログラマ</a><ul><li>MPIやスパコンの基本からわかりやすく解説している記事</li></ul></li><li><a href=https://docs.abci.ai/ja/>ABCI 2.0 User Guide</a><ul><li>ABCI (AI橋渡しクラウド) のユーザーガイド</li></ul></li><li><a href=https://www.slideshare.net/pfi/20201023-optunalectureatnagoyauni-238946529>不老におけるOptunaを利用した分散ハイパーパラメータ最適化 - 今村秀明（名古屋大学 Optuna講習会）</a><ul><li>Optuna の紹介スライド</li></ul></li></ul></div><div class=post__footer></div></div></main></div><footer class="footer footer__base"><ul class=footer__list><li class=footer__item>&copy;
ohtaman
2025</li></ul></footer><script type=text/javascript src=/js/medium-zoom.min.1248fa75275e5ef0cbef27e8c1e27dc507c445ae3a2c7d2ed0be0809555dac64.js integrity="sha256-Ekj6dSdeXvDL7yfoweJ9xQfERa46LH0u0L4ICVVdrGQ=" crossorigin=anonymous></script></body></html>